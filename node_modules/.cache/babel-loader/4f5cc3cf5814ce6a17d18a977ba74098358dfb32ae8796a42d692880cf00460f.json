{"ast":null,"code":"import { createCancellableOperation } from '../../utils/createCancellableOperation.mjs';\nimport '@aws-amplify/core/internals/aws-client-utils';\nimport '@aws-amplify/core/internals/utils';\nimport '../../errors/validation.mjs';\nimport '../../utils/logger.mjs';\nimport { transferHandler } from './handler.mjs';\n\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n/**\n * This weak map provides functionality to cancel a request given the promise containing the `post` request.\n *\n * 1. For every GraphQL POST request, an abort controller is created and supplied to the request.\n * 2. The promise fulfilled by GraphGL POST request is then mapped to that abort controller.\n * 3. The promise is returned to the external caller.\n * 4. The caller can either wait for the promise to fulfill or call `cancel(promise)` to cancel the request.\n * 5. If `cancel(promise)` is called, then the corresponding abort controller is retrieved from the map below.\n * 6. GraphQL POST request will be rejected with the error message provided during cancel.\n * 7. Caller can check if the error is because of cancelling by calling `isCancelError(error)`.\n */\nconst cancelTokenMap = new WeakMap();\n/**\n * @internal\n */\nconst post = (amplify, {\n  url,\n  options,\n  abortController\n}) => {\n  const controller = abortController ?? new AbortController();\n  const responsePromise = createCancellableOperation(async () => {\n    const response = transferHandler(amplify, {\n      url,\n      method: 'POST',\n      ...options,\n      abortSignal: controller.signal\n    }, options?.signingServiceInfo);\n    return response;\n  }, controller);\n  const responseWithCleanUp = responsePromise.finally(() => {\n    cancelTokenMap.delete(responseWithCleanUp);\n  });\n  return responseWithCleanUp;\n};\n/**\n * Cancels a request given the promise returned by `post`.\n * If the request is already completed, this function does nothing.\n * It MUST be used after `updateRequestToBeCancellable` is called.\n */\nconst cancel = (promise, message) => {\n  const controller = cancelTokenMap.get(promise);\n  if (controller) {\n    controller.abort(message);\n    if (message && controller.signal.reason !== message) {\n      // In runtimes where `AbortSignal.reason` is not supported, we track the reason ourselves.\n      // @ts-expect-error reason is read-only property.\n      controller.signal.reason = message;\n    }\n    return true;\n  }\n  return false;\n};\n/**\n * MUST be used to make a promise including internal `post` API call cancellable.\n */\nconst updateRequestToBeCancellable = (promise, controller) => {\n  cancelTokenMap.set(promise, controller);\n};\nexport { cancel, post, updateRequestToBeCancellable };","map":{"version":3,"names":["cancelTokenMap","WeakMap","post","amplify","url","options","abortController","controller","AbortController","responsePromise","createCancellableOperation","response","transferHandler","method","abortSignal","signal","signingServiceInfo","responseWithCleanUp","finally","delete","cancel","promise","message","get","abort","reason","updateRequestToBeCancellable","set"],"sources":["/Users/raphaperso/Documents/Hub/FreeCodeCamp/amplify_notes/node_modules/@aws-amplify/api-rest/src/apis/common/internalPost.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { createCancellableOperation } from '../../utils';\nimport { transferHandler } from './handler';\n/**\n * This weak map provides functionality to cancel a request given the promise containing the `post` request.\n *\n * 1. For every GraphQL POST request, an abort controller is created and supplied to the request.\n * 2. The promise fulfilled by GraphGL POST request is then mapped to that abort controller.\n * 3. The promise is returned to the external caller.\n * 4. The caller can either wait for the promise to fulfill or call `cancel(promise)` to cancel the request.\n * 5. If `cancel(promise)` is called, then the corresponding abort controller is retrieved from the map below.\n * 6. GraphQL POST request will be rejected with the error message provided during cancel.\n * 7. Caller can check if the error is because of cancelling by calling `isCancelError(error)`.\n */\nconst cancelTokenMap = new WeakMap();\n/**\n * @internal\n */\nexport const post = (amplify, { url, options, abortController }) => {\n    const controller = abortController ?? new AbortController();\n    const responsePromise = createCancellableOperation(async () => {\n        const response = transferHandler(amplify, {\n            url,\n            method: 'POST',\n            ...options,\n            abortSignal: controller.signal,\n        }, options?.signingServiceInfo);\n        return response;\n    }, controller);\n    const responseWithCleanUp = responsePromise.finally(() => {\n        cancelTokenMap.delete(responseWithCleanUp);\n    });\n    return responseWithCleanUp;\n};\n/**\n * Cancels a request given the promise returned by `post`.\n * If the request is already completed, this function does nothing.\n * It MUST be used after `updateRequestToBeCancellable` is called.\n */\nexport const cancel = (promise, message) => {\n    const controller = cancelTokenMap.get(promise);\n    if (controller) {\n        controller.abort(message);\n        if (message && controller.signal.reason !== message) {\n            // In runtimes where `AbortSignal.reason` is not supported, we track the reason ourselves.\n            // @ts-expect-error reason is read-only property.\n            controller.signal.reason = message;\n        }\n        return true;\n    }\n    return false;\n};\n/**\n * MUST be used to make a promise including internal `post` API call cancellable.\n */\nexport const updateRequestToBeCancellable = (promise, controller) => {\n    cancelTokenMap.set(promise, controller);\n};\n"],"mappings":";;;;;;;AAAA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMA,cAAc,GAAG,IAAIC,OAAO,EAAE;AACpC;AACA;AACA;AACY,MAACC,IAAI,GAAGA,CAACC,OAAO,EAAE;EAAEC,GAAG;EAAEC,OAAO;EAAEC;AAAe,CAAE,KAAK;EAChE,MAAMC,UAAU,GAAGD,eAAe,IAAI,IAAIE,eAAe,EAAE;EAC3D,MAAMC,eAAe,GAAGC,0BAA0B,CAAC,YAAY;IAC3D,MAAMC,QAAQ,GAAGC,eAAe,CAACT,OAAO,EAAE;MACtCC,GAAG;MACHS,MAAM,EAAE,MAAM;MACd,GAAGR,OAAO;MACVS,WAAW,EAAEP,UAAU,CAACQ;IACpC,CAAS,EAAEV,OAAO,EAAEW,kBAAkB,CAAC;IAC/B,OAAOL,QAAQ;EACvB,CAAK,EAAEJ,UAAU,CAAC;EACd,MAAMU,mBAAmB,GAAGR,eAAe,CAACS,OAAO,CAAC,MAAM;IACtDlB,cAAc,CAACmB,MAAM,CAACF,mBAAmB,CAAC;EAClD,CAAK,CAAC;EACF,OAAOA,mBAAmB;AAC9B;AACA;AACA;AACA;AACA;AACA;AACY,MAACG,MAAM,GAAGA,CAACC,OAAO,EAAEC,OAAO,KAAK;EACxC,MAAMf,UAAU,GAAGP,cAAc,CAACuB,GAAG,CAACF,OAAO,CAAC;EAC9C,IAAId,UAAU,EAAE;IACZA,UAAU,CAACiB,KAAK,CAACF,OAAO,CAAC;IACzB,IAAIA,OAAO,IAAIf,UAAU,CAACQ,MAAM,CAACU,MAAM,KAAKH,OAAO,EAAE;MAC7D;MACA;MACYf,UAAU,CAACQ,MAAM,CAACU,MAAM,GAAGH,OAAO;IAC9C;IACQ,OAAO,IAAI;EACnB;EACI,OAAO,KAAK;AAChB;AACA;AACA;AACA;AACY,MAACI,4BAA4B,GAAGA,CAACL,OAAO,EAAEd,UAAU,KAAK;EACjEP,cAAc,CAAC2B,GAAG,CAACN,OAAO,EAAEd,UAAU,CAAC;AAC3C","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}